# Istio VirtualService for external traffic routing
# Routes https://{region}-$(ROUTE_HOST).{domain} -> app:443 through mesh gateway
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: $(APP_NAME)-vs
  namespace: $(NAMESPACE)
  labels:
    app: $(APP_NAME)
    compliance.region: $(REGION)
spec:
  hosts:
  - $(REGION)-$(ROUTE_HOST).$(K3S_INGRESS_DOMAIN)
  gateways:
  - istio-system/$(GATEWAY_NAME)
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: $(APP_NAME).$(NAMESPACE).svc.cluster.local
        port:
          number: 443
    headers:
      response:
        add:
          # Security headers for compliance
          X-Frame-Options: DENY
          X-Content-Type-Options: nosniff
          X-XSS-Protection: "1; mode=block"
          Strict-Transport-Security: "max-age=31536000; includeSubDomains"
          Content-Security-Policy: "default-src 'self'"
